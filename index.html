<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Nghiên Cứu Ngoại Ngữ - AI & Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script type="module">
        // Sử dụng import namespace (*) để tải toàn bộ module Lucide
        import * as lucide from 'https://unpkg.com/lucide@latest';
        window.lucide = lucide;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-button { transition: all 0.3s; border-radius: 0.5rem 0.5rem 0 0; }
        .tab-button.active { background-color: #ffffff; color: #4f46e5; border-bottom: 3px solid #4f46e5; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 350px; max-height: 400px; }
        .details-summary { padding: 1rem 1.5rem; font-weight: 600; cursor: pointer; display: block; }
        .details-summary::-webkit-details-marker { display: none; }
        .details-content { padding: 1.5rem; background-color: #ffffff; }
        .text-primary { color: #4f46e5; }
        .text-secondary { color: #14b8a6; }
        .text-accent-red { color: #ef4444; }
        .bg-primary-light { background-color: #eef2ff; }
        /* Responsive Table adjustments */
        @media (max-width: 768px) {
            .details-content table { font-size: 0.75rem; }
            .details-content th, .details-content td { padding-left: 0.25rem; padding-right: 0.25rem; }
            .details-content table td:first-child { min-width: 150px; }
            .chart-container { height: 280px; max-height: 300px; }
        }
        
        /* THÊM: Style cho Game */
        .whitespace-pre-wrap {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-indigo-700">ỨNG DỤNG HỌC NGOẠI NGỮ (AI & GAME)</h1>
                <nav class="flex space-x-2 sm:space-x-4">
                    <button id="tab-overview" class="tab-button active text-sm sm:text-base px-3 py-2 text-indigo-700 hover:text-indigo-500">Tổng Quan</button>
                    <button id="tab-research" class="tab-button text-sm sm:text-base px-3 py-2 text-gray-600 hover:text-indigo-500">Nghiên Cứu</button>
                    <button id="tab-game" class="tab-button text-sm sm:text-base px-3 py-2 text-gray-600 hover:text-indigo-500">Game Demo</button>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div id="content-overview" class="tab-content space-y-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl card">
                <h2 class="text-3xl font-bold mb-4 text-indigo-700">Tổng Quan Nghiên Cứu & Ứng Dụng</h2>
                <p class="text-gray-600 leading-relaxed">Phần này cung cấp cái nhìn tổng quát về kết quả khảo sát "Thái độ và Nhận thức của học sinh Phổ thông về việc học ngoại ngữ qua ChatGPT" và tóm tắt mô hình ứng dụng game được đề xuất. Dữ liệu khảo sát ($N=100$) được trình bày qua các chỉ số và biểu đồ chính, giúp người dùng nhanh chóng nắm bắt các xu hướng quan trọng.</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-xl card flex flex-col items-center justify-center border-b-4 border-indigo-500">
                    <div class="text-5xl font-extrabold text-indigo-600" id="stat-pu">0.00</div>
                    <div class="text-lg font-medium text-gray-500 mt-2">Tính Hữu Ích Cảm Nhận </div>
                    <div class="text-sm text-gray-400 mt-1">Đánh giá cao khả năng Viết.</div>
                </div>
                <div class="bg-white p-6 rounded-xl card flex flex-col items-center justify-center border-b-4 border-teal-500">
                    <div class="text-5xl font-extrabold text-teal-600" id="stat-peou">0.00</div>
                    <div class="text-lg font-medium text-gray-500 mt-2">Tính Dễ Sử Dụng </div>
                    <div class="text-sm text-gray-400 mt-1">Giao diện đơn giản, dễ thao tác.</div>
                </div>
                <div class="bg-white p-6 rounded-xl card flex flex-col items-center justify-center border-b-4 border-indigo-300">
                    <div class="text-5xl font-extrabold text-indigo-400" id="stat-at">0.00</div>
                    <div class="text-lg font-medium text-gray-500 mt-2">Thái Độ Tích Cực </div>
                    <div class="text-sm text-gray-400 mt-1">Hứng thú và xem là trải nghiệm thú vị.</div>
                </div>
                <div class="bg-white p-6 rounded-xl card flex flex-col items-center justify-center border-b-4 border-red-500">
                    <div class="text-5xl font-extrabold text-red-600" id="stat-erp">0.00</div>
                    <div class="text-lg font-medium text-gray-500 mt-2">Nhận thức Rủi ro </div>
                    <div class="text-sm text-gray-400 mt-1">Lo ngại cao về sự phụ thuộc.</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl card flex flex-col">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">So sánh Nhận thức (PU vs PEOU)</h3>
                    <p class="text-sm text-gray-500 mb-4">Biểu đồ so sánh điểm trung bình giữa Tính Hữu Ích và Tính Dễ Sử Dụng cảm nhận. PEOU cao hơn cho thấy nền tảng AI dễ dàng tiếp cận người dùng.</p>
                    <div class="chart-container flex-grow">
                        <canvas id="chart-pu-peou"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl card flex flex-col">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Thái độ và Rủi ro (AT vs ERP)</h3>
                    <p class="text-sm text-gray-500 mb-4">Mối quan hệ giữa Thái độ tích cực (AT) và mức độ Nhận thức rủi ro (ERP). Sự chênh lệch giữa hai yếu tố này là nền tảng cho hành vi sử dụng.</p>
                    <div class="chart-container flex-grow">
                        <canvas id="chart-at-erp"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 sm:p-8 rounded-xl card border-t-4 border-teal-500">
                <h2 class="text-3xl font-bold mb-4 text-teal-700">Mô Hình Ứng Dụng Game Hóa</h2>
                <p class="text-gray-600 leading-relaxed mb-4">Phần này tóm tắt ý tưởng phát triển một ứng dụng học ngoại ngữ tích hợp yếu tố Game hóa, tập trung vào việc **tăng cường kỹ năng Hội thoại (Speaking)** – khía cạnh được đánh giá thấp nhất trong thang đo PU. Ứng dụng sẽ sử dụng AI để tạo kịch bản nhập vai và phản hồi trực tiếp, biến việc học thành một trải nghiệm giải trí, kích thích hành vi đối phó rủi ro (RC) tích cực.</p>
                <button onclick="changeTab('game')" class="mt-4 bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-md">
                    Khám phá Game Demo
                </button>
            </div>
        </div>

        <div id="content-research" class="tab-content hidden space-y-8">
            <div class="space-y-6">
                <div class="bg-white p-6 sm:p-8 rounded-xl card">
                    <h2 class="text-3xl font-bold mb-4 text-indigo-700">Nghiên Cứu & Phân Tích Chuyên Sâu</h2>
                    <p class="text-gray-600 leading-relaxed">Phần này cung cấp các bảng dữ liệu khảo sát chi tiết theo từng mục (Item), cùng với các tài liệu và hướng dẫn ứng dụng AI có trách nhiệm, phục vụ cho mục đích phân tích học thuật và đưa ra khuyến nghị.</p>
                </div>
                
                <div class="bg-white rounded-xl card mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 p-6 border-b flex items-center">
                        <span class="mr-2 text-indigo-500"></span> Tài liệu & Hướng dẫn Chi tiết
                    </h2>

                    <details class="border-b" open>
                        <summary class="details-summary bg-gray-50 hover:bg-gray-100">Chi tiết Dữ liệu Khảo sát (Theo từng Item - N=100)</summary>
                        <div class="details-content space-y-6">
                            <p class="text-sm mb-3 text-gray-600">Dữ liệu tổng hợp (N=100) chi tiết tỷ lệ phản hồi (Thang đo Likert 5 mức: 1=Hoàn toàn Không đồng ý đến 5=Hoàn toàn Đồng ý) cho từng phát biểu.</p>
                            
                            <h4 class="text-lg font-semibold text-primary">1. Nhận thức về Tính hữu ích (Perceived Usefulness - PU)</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phát biểu (PU)</th>
                                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="Hoàn toàn Không đồng ý">(1) %</th>
                                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="Không đồng ý">(2) %</th>
                                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="Bình thường">(3) %</th>
                                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="Đồng ý">(4) %</th>
                                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="Hoàn toàn Đồng ý">(5) %</th>
                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Trung bình </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                        <tr><td class="px-4 py-3 font-medium">PU4: Cải thiện kỹ năng Viết</td><td class="px-2 py-3 text-center">2%</td><td class="px-2 py-3 text-center">3%</td><td class="px-2 py-3 text-center">10.0%</td><td class="px-2 py-3 text-center">35.0%</td><td class="px-2 py-3 text-center font-bold text-primary">50.0%</td><td class="px-4 py-3 text-center font-bold text-primary">4.25</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">PU2: Hữu ích học từ vựng/ngữ pháp</td><td class="px-2 py-3 text-center">1.0%</td><td class="px-2 py-3 text-center">4.0%</td><td class="px-2 py-3 text-center">15.0%</td><td class="px-2 py-3 text-center font-bold">40.0%</td><td class="px-2 py-3 text-center font-bold text-primary">40.0%</td><td class="px-4 py-3 text-center font-bold text-primary">4.10</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">PU3: Giúp tiết kiệm thời gian</td><td class="px-2 py-3 text-center">3.0%</td><td class="px-2 py-3 text-center">8.0%</td><td class="px-2 py-3 text-center">18.0%</td><td class="px-2 py-3 text-center font-bold">38.0%</td><td class="px-2 py-3 text-center">33.0%</td><td class="px-4 py-3 text-center font-bold text-primary">3.95</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">PU5: Hỗ trợ luyện tập hội thoại (Nói)</td><td class="px-2 py-3 text-center">5.0%</td><td class="px-2 py-3 text-center">12.0%</td><td class="px-2 py-3 text-center">20.0%</td><td class="px-2 py-3 text-center font-bold">35.0%</td><td class="px-2 py-3 text-center">28.0%</td><td class="px-4 py-3 text-center font-bold text-gray-700">3.65</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">PU1: Giúp cải thiện điểm số</td><td class="px-2 py-3 text-center">6.0%</td><td class="px-2 py-3 text-center">15.0%</td><td class="px-2 py-3 text-center">24.0%</td><td class="px-2 py-3 text-center">30.0%</td><td class="px-2 py-3 text-center">25.0%</td><td class="px-4 py-3 text-center font-bold text-gray-700">3.50</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <h4 class="text-lg font-semibold text-secondary mt-6">2. Nhận thức về Tính dễ sử dụng (Perceived Ease of Use - PEOU)</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phát biểu (PEOU)</th>
                                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(1) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(2) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(3) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(4) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(5) %</th>
                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Trung bình </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                        <tr><td class="px-4 py-3 font-medium">PEOU2: Giao diện thân thiện</td><td class="px-2 py-3 text-center">1.0%</td><td class="px-2 py-3 text-center">2.0%</td><td class="px-2 py-3 text-center">9.0%</td><td class="px-2 py-3 text-center font-bold">45.0%</td><td class="px-2 py-3 text-center font-bold text-secondary">43.0%</td><td class="px-4 py-3 text-center font-bold text-secondary">4.30</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">PEOU1: Rất dễ dàng sử dụng</td><td class="px-2 py-3 text-center">1.0%</td><td class="px-2 py-3 text-center">3.0%</td><td class="px-2 py-3 text-center">12.0%</td><td class="px-2 py-3 text-center font-bold">40.0%</td><td class="px-2 py-3 text-center font-bold text-secondary">44.0%</td><td class="px-4 py-3 text-center font-bold text-secondary">4.20</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">PEOU3: Dễ dàng tìm thấy câu trả lời</td><td class="px-2 py-3 text-center">2.0%</td><td class="px-2 py-3 text-center">5.0%</td><td class="px-2 py-3 text-center">10.0%</td><td class="px-2 py-3 text-center font-bold">48.0%</td><td class="px-2 py-3 text-center">35.0%</td><td class="px-4 py-3 text-center font-bold text-secondary">4.15</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <h4 class="text-lg font-semibold text-primary mt-6">3. Thái độ sử dụng (Attitude toward Usage - AT)</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phát biểu (AT)</th>
                                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(1) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(2) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(3) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(4) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(5) %</th>
                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Trung bình </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                        <tr><td class="px-4 py-3 font-medium">AT2: Là một trải nghiệm thú vị</td><td class="px-2 py-3 text-center">1.0%</td><td class="px-2 py-3 text-center">3.0%</td><td class="px-2 py-3 text-center">6.0%</td><td class="px-2 py-3 text-center">40.0%</td><td class="px-2 py-3 text-center font-bold text-primary">50.0%</td><td class="px-4 py-3 text-center font-bold text-primary">4.35</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">AT1: Cảm thấy hứng thú và thích thú</td><td class="px-2 py-3 text-center">2.0%</td><td class="px-2 py-3 text-center">4.0%</td><td class="px-2 py-3 text-center">10.0%</td><td class="px-2 py-3 text-center">38.0%</td><td class="px-2 py-3 text-center font-bold text-primary">46.0%</td><td class="px-4 py-3 text-center font-bold text-primary">4.20</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">AT3: Tin rằng là một ý tưởng tốt</td><td class="px-2 py-3 text-center">1.0%</td><td class="px-2 py-3 text-center">5.0%</td><td class="px-2 py-3 text-center">15.0%</td><td class="px-2 py-3 text-center font-bold">40.0%</td><td class="px-2 py-3 text-center">39.0%</td><td class="px-4 py-3 text-center font-bold text-primary">4.15</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <h4 class="text-lg font-semibold text-accent-red mt-6">4. Nhận thức về Rủi ro Đạo đức Học thuật (Ethics & Risk Perception - ERP)</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phát biểu (ERP)</th>
                                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(1) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(2) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(3) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(4) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(5) %</th>
                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Trung bình </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                        <tr><td class="px-4 py-3 font-medium">ERP2: Sợ bị phụ thuộc/lười tư duy</td><td class="px-2 py-3 text-center">2.0%</td><td class="px-2 py-3 text-center">5.0%</td><td class="px-2 py-3 text-center">15.0%</td><td class="px-2 py-3 text-center">35.0%</td><td class="px-2 py-3 text-center font-bold text-accent-red">43.0%</td><td class="px-4 py-3 text-center font-bold text-accent-red">4.10</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">ERP1: Lo lắng về gian lận học thuật</td><td class="px-2 py-3 text-center">5.0%</td><td class="px-2 py-3 text-center">10.0%</td><td class="px-2 py-3 text-center">20.0%</td><td class="px-2 py-3 text-center font-bold">35.0%</td><td class="px-2 py-3 text-center">30.0%</td><td class="px-4 py-3 text-center font-bold text-accent-red">3.85</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">ERP4: Giáo viên nên cấm sử dụng</td><td class="px-2 py-3 text-center font-bold text-gray-700">20.0%</td><td class="px-2 py-3 text-center">18.0%</td><td class="px-2 py-3 text-center">17.0%</td><td class="px-2 py-3 text-center">25.0%</td><td class="px-2 py-3 text-center">20.0%</td><td class="px-4 py-3 text-center font-bold text-gray-700">3.20</td></tr>
                                        <tr><td class="px-4 py-3 font-medium italic">(Ngược) ERP3: Luôn chính xác</td><td class="px-2 py-3 text-center font-bold text-gray-700">45.0%</td><td class="px-2 py-3 text-center font-bold text-gray-700">30.0%</td><td class="px-2 py-3 text-center">15.0%</td><td class="px-2 py-3 text-center">7.0%</td><td class="px-2 py-3 text-center">3.0%</td><td class="px-4 py-3 text-center font-bold text-gray-700">2.50</td></tr>
                                    </tbody>
                                </table>
                            </div>
                             <p class="text-xs text-gray-500 mt-2 italic">Lưu ý: Phát biểu ERP3 là phát biểu ngược, điểm trung bình thấp thể hiện nhận thức đúng đắn của học sinh.</p>

                            <h4 class="text-lg font-semibold text-secondary mt-6">5. Hành vi đối phó với Rủi ro (Risk Coping - RC)</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phát biểu (RC)</th>
                                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(1) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(2) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(3) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(4) %</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">(5) %</th>
                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Trung bình </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                        <tr><td class="px-4 py-3 font-medium">RC2: Chỉ dùng để sửa chữa (không viết hộ)</td><td class="px-2 py-3 text-center">2.0%</td><td class="px-2 py-3 text-center">8.0%</td><td class="px-2 py-3 text-center">15.0%</td><td class="px-2 py-3 text-center font-bold">40.0%</td><td class="px-2 py-3 text-center font-bold text-secondary">35.0%</td><td class="px-4 py-3 text-center font-bold text-secondary">4.05</td></tr>
                                        <tr><td class="px-4 py-3 font-medium">RC1: Luôn kiểm tra lại thông tin</td><td class="px-2 py-3 text-center">5.0%</td><td class="px-2 py-3 text-center">10.0%</td><td class="px-2 py-3 text-center">25.0%</td><td class="px-2 py-3 text-center font-bold">35.0%</td><td class="px-2 py-3 text-center">25.0%</td><td class="px-4 py-3 text-center font-bold text-secondary">3.80</td></tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </details>
                    <details class="border-b"><summary class="details-summary bg-gray-50 hover:bg-gray-100">Ví dụ Bài tập Ứng dụng AI (Prompt Phản biện)</summary><div class="details-content"><p class="font-bold mb-2 text-indigo-700">Mục tiêu: Phát triển tư duy phản biện.</p><div class="bg-white p-4 rounded-lg border border-indigo-200"><h4 class="font-semibold text-lg mb-2">Bài tập "Thách thức AI" (Khối 11/12)</h4><ol class="list-decimal list-inside text-gray-700 space-y-2"><li>Yêu cầu ChatGPT viết một đoạn văn (150 từ) về chủ đề "Tác động của mạng xã hội".</li><li><span class="font-medium text-secondary">Bước Phản biện:</span> Tìm ra 5 câu/cụm từ của AI có thể được diễn đạt tốt hơn.</li><li>Viết lại đoạn văn và giải thích lý do thay đổi.</li></ol></div></div></details>
                    <details class="border-b"><summary class="details-summary bg-gray-50 hover:bg-gray-100">Hướng dẫn Sử dụng AI Có Trách nhiệm</summary><div class="details-content"><p class="font-bold mb-3 text-indigo-700">Các bước hành động thực tiễn cho học sinh:</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="p-4 bg-white rounded-lg border border-teal-300"><h4 class="font-semibold text-teal-700 mb-2">✅ Làm chủ Kỹ thuật Prompt: Tối ưu cho Nghe & Nói</h4><ul class="list-disc list-outside ml-5 text-gray-700 text-sm"><li>Đưa ra vai trò cụ thể ("Act as an English teacher").</li><li>**Luyện Nói (Speaking):** Yêu cầu kịch bản đối thoại, sau đó yêu cầu AI sửa lỗi và nâng cấp câu trả lời của bạn.</li><li>**Luyện Nghe (Listening):** Yêu cầu AI cung cấp đoạn hội thoại ngắn, sau đó bạn chép lại và AI kiểm tra (Transcription).</li></ul></div><div class="p-4 bg-white rounded-lg border border-red-300"><h4 class="font-semibold text-red-700 mb-2">❌ Kiểm soát Mức độ Phụ thuộc</h4><ul class="list-disc list-outside ml-5 text-gray-700 text-sm"><li>Không dùng để viết toàn bộ bài luận.</li><li>Luôn kiểm tra chéo (Cross-check) thông tin.</li><li>Sau khi AI sửa lỗi, tự giải thích tại sao đó là lỗi.</li></ul></div></div></div></details>
                </div>
            </div>
        </div>

        <div id="content-game" class="tab-content hidden space-y-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-extrabold text-indigo-700 flex items-center justify-center">
                    <svg data-lucide="sparkles" class="w-8 h-8 mr-2 text-yellow-400"></svg>
                    4-Skill Language Trainer (AI Game)
                </h1>
                <p class="text-gray-500 mt-2">Luyện tập Nghe, Nói, Đọc, Viết với sự hỗ trợ của Gemini AI.</p>
            </header>

            <div id="game-app-container" class="max-w-4xl mx-auto">
                </div>
            
            <footer class="mt-10 text-center text-xs text-gray-400">
                <p>Powered by Gemini AI - Tool for Academic Research & Language Learning</p>
            </footer>
        </div>

    </main>

    <script>
        // --- LOGIC CỦA DASHBOARD (indexnew.html) ---
    
        const data = {
            // Updated Averages from the provided data (N=100)
            avg: {
                pu: 3.89,
                peou: 4.22,
                at: 4.17,
                erp: 3.41
            },
            // Data for PU vs PEOU Chart (Averages for each item)
            puData: [4.25, 4.10, 3.95, 3.65, 3.50], // PU4, PU2, PU3, PU5, PU1
            peouData: [4.30, 4.20, 4.15], // PEOU2, PEOU1, PEOU3
            // Data for AT vs ERP Chart (Overall Averages)
            atErpData: [4.17, 3.41]
        };

        const chartColors = {
            primary: '#4f46e5', // Indigo
            secondary: '#14b8a6', // Teal
            accentRed: '#ef4444', // Red
            gray: '#d1d5db'
        };

        function initStats() {
            const duration = 1500;
            animateValue("stat-pu", 0, data.avg.pu, duration, 2);
            animateValue("stat-peou", 0, data.avg.peou, duration, 2);
            animateValue("stat-at", 0, data.avg.at, duration, 2);
            animateValue("stat-erp", 0, data.avg.erp, duration, 2);
        }

        function animateValue(id, start, end, duration, decimals) {
            const obj = document.getElementById(id);
            if (!obj) return;
            const range = end - start;
            let current = start;
            const increment = range / (duration / 10);
            const step = Math.pow(10, decimals);
            const timer = setInterval(() => {
                current += increment;
                if ((range > 0 && current >= end) || (range < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                obj.textContent = current.toFixed(decimals);
            }, 10);
        }

        function initCharts() {
            const ctxPuPeou = document.getElementById('chart-pu-peou')?.getContext('2d');
            if (ctxPuPeou) {
                new Chart(ctxPuPeou, {
                    type: 'bar',
                    data: {
                        labels: ['PU4 (Viết)', 'PU2 (Từ Vựng)', 'PU3 (Tiết Kiệm)', 'PU5 (Hội Thoại)', 'PU1 (Điểm Số)', 'PEOU2 (Giao Diện)', 'PEOU1 (Dễ Dàng)', 'PEOU3 (Tìm Kiếm)'],
                        datasets: [{
                            label: 'Mức Độ Đồng Ý (1-5)',
                            data: [...data.puData, ...data.peouData],
                            backgroundColor: [
                                chartColors.primary, chartColors.primary, chartColors.primary, chartColors.primary, chartColors.primary,
                                chartColors.secondary, chartColors.secondary, chartColors.secondary
                            ],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'So Sánh Từng Item PU/PEOU (Điểm TB)', font: { size: 14, weight: 'bold' } },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Điểm TB: ${context.formattedValue}`
                                }
                            }
                        },
                        scales: {
                            x: { beginAtZero: true, max: 5.0, title: { display: true, text: 'Điểm Trung Bình (1-5)' } }
                        }
                    }
                });
            }

            const ctxAtErp = document.getElementById('chart-at-erp')?.getContext('2d');
            if (ctxAtErp) {
                new Chart(ctxAtErp, {
                    type: 'polarArea',
                    data: {
                        labels: ['Thái Độ Tích Cực ($\bar{X}_{AT}$)', 'Nhận thức Rủi ro ($\bar{X}_{ERP}$)'],
                        datasets: [{
                            data: data.atErpData,
                            backgroundColor: [chartColors.primary, chartColors.accentRed],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Thái Độ vs Rủi Ro (Điểm TB Tổng Thể)', font: { size: 14, weight: 'bold' } },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.label}: ${context.formattedValue}`
                                }
                            }
                        },
                        scales: {
                            r: { suggestedMin: 0, suggestedMax: 5, pointLabels: { display: true, centerPointLabels: true, font: { size: 14 } } }
                        }
                    }
                });
            }
        }

        // THÊM: Cờ trạng thái cho Game
        let isGameInitialized = false;

        function changeTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            const contentEl = document.getElementById(`content-${tabId}`);
            if (contentEl) {
                contentEl.classList.remove('hidden');
            }

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'text-indigo-700');
                button.classList.add('text-gray-600');
            });
            const activeBtn = document.getElementById(`tab-${tabId}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'text-indigo-700');
                activeBtn.classList.remove('text-gray-600');
            }

            // LOGIC KHỞI TẠO GAME KHI CHUYỂN TAB
            if (tabId === 'game') {
                if (!isGameInitialized) {
                    game_renderApp(); // Render giao diện game tức thời
                    game_generateTask(game_state.activeSkillId); // Tải bài tập ngầm
                    isGameInitialized = true;
                } else {
                    // Đảm bảo giao diện game được render lại (để cập nhật Lucide Icons)
                    game_renderApp(); 
                    // Tải lại nếu chưa có task và không đang tải (ví dụ: bị lỗi tải lần trước)
                    if (!game_state.task && !game_state.isLoading) {
                         game_generateTask(game_state.activeSkillId);
                    }
                }
            }
        }

        // --- LOGIC CỦA GAME (4_Skill_Trainer_HTML.html) ---
        // (Đã được đổi tên với tiền tố 'game_' để tránh xung đột)

        const apiKey = "AIzaSyBIAcEsS_w9jfHeOQ11W-nvcBdC3bSHXbk"; // API Key chung
        const GAME_GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const GAME_TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

        // Hàm tiện ích của Game
        const game_base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const game_pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM
            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(buffer);
            let offset = 0;
            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset++, str.charCodeAt(i));
                }
            };
            writeString('RIFF');
            view.setUint32(offset, 36 + pcmData.byteLength, true); offset += 4;
            writeString('WAVE');
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, sampleRate * numChannels * bytesPerSample, true); offset += 4;
            view.setUint16(offset, numChannels * bytesPerSample, true); offset += 2;
            view.setUint16(offset, bytesPerSample * 8, true); offset += 2;
            writeString('data');
            view.setUint32(offset, pcmData.byteLength, true); offset += 4;
            const pcm8 = new Uint8Array(pcmData.buffer);
            for (let i = 0; i < pcm8.length; i++) {
                view.setUint8(offset++, pcm8[i]);
            }
            return new Blob([buffer], { type: 'audio/wav' });
        };

        // Cấu hình Game
        const GAME_SKILLS = {
            READING: { id: 'READING', name: 'Đọc & Hiểu', icon: 'Volume2', color: 'text-indigo-600', prompt: "Tạo một đoạn văn ngắn (khoảng 50 từ, cấp độ B1) về chủ đề 'Lợi ích của việc đọc sách', sau đó tạo một câu hỏi trắc nghiệm (A, B, C) về nội dung đoạn văn. Định dạng phản hồi là JSON." },
            WRITING: { id: 'WRITING', name: 'Viết & Sửa lỗi', icon: 'PenTool', color: 'text-green-600', prompt: "Tạo một câu hỏi yêu cầu người học viết 3-4 câu về một chủ đề đơn giản (ví dụ: 'Describe your favorite type of weather and why you like it'). Định dạng phản hồi là JSON." },
            LISTENING: { id: 'LISTENING', name: 'Nghe & Lặp lại', icon: 'Volume2', color: 'text-red-600', prompt: "Tạo một câu tiếng Anh ngắn (không quá 10 từ) có sử dụng một thành ngữ thông dụng (idiom) để người học nghe và lặp lại. Định dạng phản hồi là JSON." },
            SPEAKING: { id: 'SPEAKING', name: 'Nói & Phản hồi', icon: 'Mic', color: 'text-orange-600', prompt: "Tạo một tình huống giao tiếp ngắn (1-2 câu) yêu cầu người học phản hồi bằng tiếng Anh. Định dạng phản hồi là JSON." },
        };

        const GAME_SCHEMA = {
            type: "OBJECT",
            properties: {
                taskName: { type: "STRING", description: "Tên ngắn gọn của bài tập." },
                instruction: { type: "STRING", description: "Hướng dẫn cho người học." },
                content: { type: "STRING", description: "Nội dung chính của bài tập (đoạn văn, câu nói, tình huống)." },
                keyAnswer: { type: "STRING", description: "Đáp án hoặc gợi ý chính xác (chỉ dùng cho mục đích đối chiếu)." },
                extraData: { type: "ARRAY", items: { type: "STRING" } }
            },
            propertyOrdering: ["taskName", "instruction", "content", "keyAnswer", "extraData"]
        };

        // Trạng thái Game
        let game_state = {
            activeSkillId: GAME_SKILLS.READING.id,
            task: null,
            userAnswer: '',
            feedback: null,
            isLoading: false,
            audioUrl: null,
            voiceName: 'Kore'
        };

        const game_setState = (newState) => {
            game_state = { ...game_state, ...newState };
            game_renderApp();
        };

        // Hàm xử lý chính của Game
        const game_generateAudio = async (text) => {
            const ttsPayload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: game_state.voiceName } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            try {
                const response = await fetch(GAME_TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ttsPayload)
                });
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    const pcmData = game_base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = game_pcmToWav(pcm16, sampleRate);
                    game_setState({ audioUrl: URL.createObjectURL(wavBlob) });
                } else {
                    console.error("Lỗi TTS: Dữ liệu âm thanh không hợp lệ.");
                }
            } catch (error) {
                console.error("Lỗi khi gọi API TTS:", error);
            }
        };

        const game_generateTask = async (skillId) => {
            const skill = GAME_SKILLS[skillId];
            if (!skill) return;
            game_setState({ isLoading: true, task: null, feedback: null, userAnswer: '', audioUrl: null });
            try {
                const systemPrompt = `Bạn là một giáo viên tiếng Anh AI. Nhiệm vụ của bạn là tạo một bài tập luyện kỹ năng theo yêu cầu sau và đảm bảo phản hồi phải ở định dạng JSON hợp lệ. Đảm bảo tất cả nội dung tiếng Anh phải ở cấp độ B1 hoặc THPT.`;
                const payload = {
                    contents: [{ parts: [{ text: skill.prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json", responseSchema: GAME_SCHEMA }
                };
                const response = await fetch(GAME_GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (jsonText) {
                    const parsedTask = JSON.parse(jsonText);
                    game_setState({ task: parsedTask, isLoading: false });
                    if (skill.id === 'LISTENING') {
                        await game_generateAudio(parsedTask.content);
                    }
                } else {
                    console.error("Lỗi: Không nhận được JSON hợp lệ từ Gemini.");
                    game_setState({ isLoading: false });
                }
            } catch (error) {
                console.error('Lỗi khi tạo bài tập:', error);
                game_setState({ feedback: { type: 'error', message: 'Không thể tạo bài tập. Vui lòng thử lại.' }, isLoading: false });
            }
        };

        const game_submitAnswer = async () => {
            const currentSkill = GAME_SKILLS[game_state.activeSkillId];
            if (!game_state.userAnswer.trim()) {
                game_setState({ feedback: { type: 'warning', message: 'Vui lòng nhập câu trả lời của bạn.' } });
                return;
            }
            game_setState({ isLoading: true, feedback: null });
            const reviewPrompt = `Tôi đang thực hiện bài tập ${currentSkill.name} với nội dung: "${game_state.task.content}". Tôi đã trả lời như sau: "${game_state.userAnswer}". Dựa trên đáp án đúng là: "${game_state.task.keyAnswer}", vui lòng: 1. Đánh giá câu trả lời của tôi (Đúng/Sai hoặc Mức độ phù hợp). 2. Giải thích lý do và cung cấp một đoạn sửa lỗi (nếu có). 3. Cho một điểm số (ví dụ: 8/10). Phản hồi bằng tiếng Việt.`;
            try {
                const response = await fetch(GAME_GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: reviewPrompt }] }] }),
                });
                const result = await response.json();
                const reviewText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                game_setState({ feedback: { type: 'success', message: reviewText }, isLoading: false });
            } catch (error) {
                console.error('Lỗi khi đánh giá câu trả lời:', error);
                game_setState({ feedback: { type: 'error', message: 'Không thể đánh giá câu trả lời. Vui lòng kiểm tra kết nối.' }, isLoading: false });
            }
        };

        // Event Handlers của Game
        const game_handleSkillChange = (skillId) => {
            if (skillId === game_state.activeSkillId) return;
            game_setState({ activeSkillId: skillId });
            game_generateTask(skillId);
        };

        const game_handlePlayAudio = () => {
            if (game_state.audioUrl) {
                const audio = new Audio(game_state.audioUrl);
                audio.play();
            }
        };

        // Hàm Render của Game
        const game_createIconElement = (iconName, className) => {
            const icon = document.createElement('svg');
            icon.setAttribute('data-lucide', iconName);
            icon.className = className;
            return icon;
        };

        const game_renderSkillTabs = () => {
            const tabsDiv = document.createElement('div');
            tabsDiv.className = "flex space-x-2 sm:space-x-4 mb-6 p-2 bg-white rounded-2xl shadow-xl";
            Object.values(GAME_SKILLS).forEach(skill => {
                const active = game_state.activeSkillId === skill.id;
                const button = document.createElement('button');
                button.onclick = () => game_handleSkillChange(skill.id);
                button.className = `flex-1 flex flex-col items-center p-3 sm:p-4 rounded-xl transition-all duration-300 transform border-2 ${
                    active ? 'bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg scale-105 border-white' : 'bg-white text-gray-700 hover:bg-gray-100 hover:scale-[1.02] border-gray-200'
                }`;
                const iconContainer = document.createElement('div');
                iconContainer.className = `p-2 rounded-full ${active ? 'bg-white' : 'bg-gray-100'}`;
                iconContainer.appendChild(game_createIconElement(skill.icon, `w-5 h-5 ${skill.color} ${active ? skill.color.replace('text-', 'text-') : ''}`));
                const nameSpan = document.createElement('span');
                nameSpan.className = `mt-2 text-sm font-semibold ${active ? 'text-white' : 'text-gray-700'}`;
                nameSpan.textContent = skill.name;
                button.appendChild(iconContainer);
                button.appendChild(nameSpan);
                tabsDiv.appendChild(button);
            });
            return tabsDiv;
        };

        const game_renderTaskArea = () => {
            const taskDiv = document.createElement('div');
            taskDiv.className = "bg-white p-6 sm:p-8 rounded-2xl shadow-2xl border-t-4 border-indigo-500";
            const currentSkill = GAME_SKILLS[game_state.activeSkillId];
            const header = document.createElement('h2');
            header.className = "text-xl font-bold text-gray-800 mb-4 flex items-center";
            header.appendChild(game_createIconElement(currentSkill.icon, `w-5 h-5 ${currentSkill.color}`));
            const titleSpan = document.createElement('span');
            titleSpan.className = "ml-2";
            titleSpan.textContent = `${currentSkill.name}: ${game_state.task?.taskName || 'Đang tải...'}`;
            header.appendChild(titleSpan);
            taskDiv.appendChild(header);

            if (game_state.isLoading && !game_state.task) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = "flex flex-col items-center justify-center h-40 text-indigo-500";
                loadingDiv.innerHTML = `<svg data-lucide="loader-2" class="w-8 h-8 animate-spin"></svg><p class="mt-3 font-medium">AI đang tạo bài tập cho bạn...</p>`;
                taskDiv.appendChild(loadingDiv);
                return taskDiv;
            }

            if (game_state.task) {
                const contentDiv = document.createElement('div');
                contentDiv.className = "space-y-4";
                const instructionP = document.createElement('p');
                instructionP.className = "text-lg text-gray-700 font-semibold";
                instructionP.textContent = game_state.task.instruction;
                contentDiv.appendChild(instructionP);
                const taskContentBox = document.createElement('div');
                taskContentBox.className = "bg-indigo-50 p-4 rounded-xl border border-indigo-200";

                if (currentSkill.id === 'LISTENING' && game_state.audioUrl) {
                    const audioDiv = document.createElement('div');
                    audioDiv.className = "flex items-center space-x-3 mb-3";
                    audioDiv.innerHTML = `<button id="game_playAudioBtn" class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-full shadow-md transition-transform transform hover:scale-105"><svg data-lucide="volume-2" class="w-5 h-5"></svg></button><p class="text-sm text-gray-600">Nhấn để nghe câu: "${game_state.task.content}"</p>`;
                    taskContentBox.appendChild(audioDiv);
                    setTimeout(() => {
                        document.getElementById('game_playAudioBtn')?.addEventListener('click', game_handlePlayAudio);
                    }, 0);
                } else if (currentSkill.id !== 'LISTENING') {
                    const contentP = document.createElement('p');
                    contentP.className = "text-gray-800 italic";
                    contentP.textContent = game_state.task.content;
                    taskContentBox.appendChild(contentP);
                }

                if (currentSkill.id === 'READING' && game_state.task.extraData?.length > 0) {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = "mt-4 space-y-2";
                    game_state.task.extraData.forEach((option, index) => {
                        const label = document.createElement('label');
                        label.className = "flex items-center space-x-2 text-gray-700";
                        const input = document.createElement('input');
                        input.type = "radio";
                        input.name = "reading_option";
                        input.value = option;
                        input.className = "form-radio text-indigo-600 h-4 w-4";
                        if (game_state.userAnswer === option) input.checked = true;
                        input.onchange = (e) => game_state.userAnswer = e.target.value;
                        const span = document.createElement('span');
                        span.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                        label.appendChild(input);
                        label.appendChild(span);
                        optionsDiv.appendChild(label);
                    });
                    taskContentBox.appendChild(optionsDiv);
                }
                contentDiv.appendChild(taskContentBox);

                if (currentSkill.id !== 'READING') {
                    const textarea = document.createElement('textarea');
                    textarea.value = game_state.userAnswer;
                    textarea.oninput = (e) => game_state.userAnswer = e.target.value;
                    textarea.rows = currentSkill.id === 'WRITING' ? 4 : 2;
                    textarea.placeholder = currentSkill.id === 'WRITING' ? "Viết câu trả lời của bạn vào đây..." : "Gõ câu phản hồi của bạn vào đây...";
                    textarea.className = "w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150";
                    contentDiv.appendChild(textarea);
                }

                const buttonDiv = document.createElement('div');
                buttonDiv.className = "flex justify-between items-center pt-2";
                const newBtn = document.createElement('button');
                newBtn.onclick = () => game_generateTask(game_state.activeSkillId);
                newBtn.className = "flex items-center bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-150 font-medium";
                newBtn.innerHTML = '<svg data-lucide="refresh-cw" class="w-4 h-4 mr-2"></svg>Bài tập mới';
                const submitBtn = document.createElement('button');
                submitBtn.onclick = game_submitAnswer;
                submitBtn.disabled = game_state.isLoading;
                submitBtn.className = "flex items-center bg-indigo-600 text-white px-6 py-2 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed font-semibold";
                submitBtn.innerHTML = game_state.isLoading ? '<svg data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></svg> Đang xử lý...' : '<svg data-lucide="message-square" class="w-5 h-5 mr-2"></svg> Gửi và Đánh giá';
                buttonDiv.appendChild(newBtn);
                buttonDiv.appendChild(submitBtn);
                contentDiv.appendChild(buttonDiv);
                taskDiv.appendChild(contentDiv);
            } else if (!game_state.isLoading) {
                // Hiển thị thông báo chờ nếu chưa tải xong lần đầu
                const initialLoadDiv = document.createElement('div');
                initialLoadDiv.className = "text-center text-gray-500 p-8";
                initialLoadDiv.textContent = 'Đang khởi tạo bài tập. Vui lòng đợi...';
                taskDiv.appendChild(initialLoadDiv);
            }
            return taskDiv;
        };

        const game_renderFeedbackArea = () => {
            if (!game_state.feedback) return null;
            const feedbackDiv = document.createElement('div');
            const type = game_state.feedback.type;
            const typeClass = type === 'success' ? 'bg-green-50 border-l-4 border-green-500' : type === 'error' ? 'bg-red-50 border-l-4 border-red-500' : 'bg-yellow-50 border-l-4 border-yellow-500';
            feedbackDiv.className = `mt-6 p-6 rounded-2xl shadow-xl transition-all duration-300 ${typeClass}`;
            feedbackDiv.innerHTML = `<h3 class="font-bold flex items-center text-lg mb-2">${type === 'success' ? 'Phản hồi từ AI Tutor' : 'Thông báo'}</h3><div class="text-gray-700 whitespace-pre-wrap">${game_state.feedback.message}</div>`;
            if (type === 'success' && game_state.task?.keyAnswer) {
                const keyAnswerP = document.createElement('p');
                keyAnswerP.className = "mt-3 pt-3 border-t border-gray-200 text-sm font-medium text-indigo-600";
                keyAnswerP.textContent = `Đáp án/Gợi ý chính xác: ${game_state.task.keyAnswer}`;
                feedbackDiv.appendChild(keyAnswerP);
            }
            return feedbackDiv;
        };

        const game_renderApp = () => {
            // SỬA: Target ID của container game đã được đổi tên
            const appContainer = document.getElementById('game-app-container');
            if (!appContainer) return; // Nếu tab game không active, không làm gì cả
            
            appContainer.innerHTML = ''; // Xóa nội dung cũ
            appContainer.appendChild(game_renderSkillTabs());
            appContainer.appendChild(game_renderTaskArea());
            const feedbackElement = game_renderFeedbackArea();
            if (feedbackElement) {
                appContainer.appendChild(feedbackElement);
            }
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        };
        
        // --- KẾT THÚC LOGIC CỦA GAME ---


        // --- HÀM KHỞI TẠO CHUNG (ĐÃ HỢP NHẤT) ---
        window.onload = function() {
            // 1. Khởi tạo Stats và Charts của Dashboard
            initStats();
            initCharts();
            
            // 2. Thiết lập logic chuyển Tab
            const hash = window.location.hash.replace('#', '');
            if (hash && document.getElementById(`content-${hash}`)) {
                changeTab(hash);
            } else {
                changeTab('overview');
            }
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Lấy ID tab từ target (hoặc cha của nó nếu click vào icon/text)
                    const targetButton = e.currentTarget; 
                    const tabId = targetButton.id.replace('tab-', '');
                    changeTab(tabId);
                    window.location.hash = tabId;
                });
            });
            
            // 3. KHÔNG KHỞI TẠO GAME TẠI ĐÂY NỮA. 
            // Game sẽ được khởi tạo trong hàm changeTab() khi người dùng click vào.
        };
    </script>
</body>
</html>
